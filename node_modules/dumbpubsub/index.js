var events = require('events');
var util = require('util');

var DumbPubSub = function() {
    events.EventEmitter.call(this);
    var self = this;

    self.server = null;

    self.attach = function(server) {
        self.server = server;
    };

    self.subscriptions = {
        //'client-update': [
            //'http://localhost/x',
            //'http://localhost/y',
        //],
        //'client-delete': [
            //'http://localhost/x',
        //],
    };

    /**
     * Begins listening on the provided root URL
     * root ~= /subscribe
     */
    self.listen = function(root) {

        /**
         * GET /subscribe
         * Returns all subscriptions
         *
         * GET /subscribe?event=client-delete
         * Returns all subscriptions listening for client-delete
         *
         * GET /subscribe?event=client-delete&url=http://localhost/listener
         * Returns all subscriptions listening for client-delete on this URL (1 or 0)
         */
        self.server.get(root, function(req, res) {
            // Read 'event' and 'url' get params
            var event = req.query.event;
            if (!event) {
                res.send(500);
                return;
            }
            var url = req.query.url || null;
            if (url) {
                var item = self.subscriptions[event];
                if (!item) {
                    res.send(404);
                    return;
                } else if (item && !url) {
                    res.send(item);
                    return;
                } else if (item && url) {
                    if (item[url]) {
                        res.send(item[url]);
                    } else {
                        res.send(404);
                    }
                }
            }
        });

        self.server.delete(root, function(req, res) {
            // read 'event' and 'url' something params
            console.log('event', req.body.event);
            console.log('url', req.body.url);
            res.send('deleted');
        });

        self.server.post(root, function(req, res) {
            // read 'event' and 'url' post params
            res.send('added');
        });
    };

    self.restore = function(dataStore) {
        // read old entries from disk
    };

    self.subscribe = function(event, url) {
        // Adds event to data store
    };
};

util.inherits(DumbPubSub, events.EventEmitter);
module.exports = new DumbPubSub();
